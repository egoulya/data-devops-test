## Boot process

#### 1. enable recovery options for grub, update main configuration file and find new item in grub2 config in /boot.

```bash
[hero@localhost ~]$ sudo nano /etc/default/grub 
GRUB_DISABLE_RECOVERY="false"

[hero@localhost ~]$ sudo grub2-mkconfig -o /boot/grub2/grub.cfg
[hero@localhost ~]$ reboot
[hero@localhost ~]$ sudo cat /boot/grub2/grub.cfg
#
# DO NOT EDIT THIS FILE
#
# It is automatically generated by grub2-mkconfig using templates
# from /etc/grub.d and settings from /etc/default/grub
#

### BEGIN /etc/grub.d/00_header ###
set pager=1

if [ -s $prefix/grubenv ]; then
  load_env
fi
if [ "${next_entry}" ] ; then
   set default="${next_entry}"
   set next_entry=
   save_env next_entry
   set boot_once=true
else
   set default="${saved_entry}"
fi

if [ x"${feature_menuentry_id}" = xy ]; then
  menuentry_id_option="--id"
else
  menuentry_id_option=""
fi

export menuentry_id_option

if [ "${prev_saved_entry}" ]; then
  set saved_entry="${prev_saved_entry}"
  save_env saved_entry
  set prev_saved_entry=
  save_env prev_saved_entry
  set boot_once=true
fi

function savedefault {
  if [ -z "${boot_once}" ]; then
    saved_entry="${chosen}"
    save_env saved_entry
  fi
}

function load_video {
  if [ x$feature_all_video_module = xy ]; then
    insmod all_video
  else
    insmod efi_gop
    insmod efi_uga
    insmod ieee1275_fb
    insmod vbe
    insmod vga
    insmod video_bochs
    insmod video_cirrus
  fi
}

terminal_output console
if [ x$feature_timeout_style = xy ] ; then
  set timeout_style=menu
  set timeout=5
# Fallback normal timeout code in case the timeout_style feature is
# unavailable.
else
  set timeout=5
fi
### END /etc/grub.d/00_header ###

### BEGIN /etc/grub.d/00_tuned ###
set tuned_params=""
set tuned_initrd=""
### END /etc/grub.d/00_tuned ###

### BEGIN /etc/grub.d/01_users ###
if [ -f ${prefix}/user.cfg ]; then
  source ${prefix}/user.cfg
  if [ -n "${GRUB2_PASSWORD}" ]; then
    set superusers="root"
    export superusers
    password_pbkdf2 root ${GRUB2_PASSWORD}
  fi
fi
### END /etc/grub.d/01_users ###

### BEGIN /etc/grub.d/10_linux ###
menuentry 'CentOS Linux (3.10.0-1160.el7.x86_64) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-3.10.0-1160.el7.x86_64-advanced-35b41738-ebb7-4049-b129-5e0808cdbe2b' {
        load_video
        set gfxpayload=keep
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  d5d4eaf6-818a-4bb1-b5d4-0322a07bd6d6
        else
          search --no-floppy --fs-uuid --set=root d5d4eaf6-818a-4bb1-b5d4-0322a07bd6d6
        fi
        linux16 /vmlinuz-3.10.0-1160.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet
        initrd16 /initramfs-3.10.0-1160.el7.x86_64.img
}
menuentry 'CentOS Linux (3.10.0-1160.el7.x86_64) 7 (Core) (recovery mode)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-3.10.0-1160.el7.x86_64-recovery-35b41738-ebb7-4049-b129-5e0808cdbe2b' {
        load_video
        set gfxpayload=keep
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  d5d4eaf6-818a-4bb1-b5d4-0322a07bd6d6
        else
          search --no-floppy --fs-uuid --set=root d5d4eaf6-818a-4bb1-b5d4-0322a07bd6d6
        fi
        linux16 /vmlinuz-3.10.0-1160.el7.x86_64 root=/dev/mapper/centos-root ro single crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet
        initrd16 /initramfs-3.10.0-1160.el7.x86_64.img
}
menuentry 'CentOS Linux (0-rescue-2bd26f952d87453faf6cde78d6300ab1) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-0-rescue-2bd26f952d87453faf6cde78d6300ab1-advanced-35b41738-ebb7-4049-b129-5e0808cdbe2b' {
        load_video
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  d5d4eaf6-818a-4bb1-b5d4-0322a07bd6d6
        else
          search --no-floppy --fs-uuid --set=root d5d4eaf6-818a-4bb1-b5d4-0322a07bd6d6
        fi
        linux16 /vmlinuz-0-rescue-2bd26f952d87453faf6cde78d6300ab1 root=/dev/mapper/centos-root ro crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet
        initrd16 /initramfs-0-rescue-2bd26f952d87453faf6cde78d6300ab1.img
}
menuentry 'CentOS Linux (0-rescue-2bd26f952d87453faf6cde78d6300ab1) 7 (Core) (recovery mode)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-0-rescue-2bd26f952d87453faf6cde78d6300ab1-recovery-35b41738-ebb7-4049-b129-5e0808cdbe2b' {
        load_video
        insmod gzio
        insmod part_msdos
        insmod xfs
        set root='hd0,msdos1'
        if [ x$feature_platform_search_hint = xy ]; then
          search --no-floppy --fs-uuid --set=root --hint-bios=hd0,msdos1 --hint-efi=hd0,msdos1 --hint-baremetal=ahci0,msdos1 --hint='hd0,msdos1'  d5d4eaf6-818a-4bb1-b5d4-0322a07bd6d6
        else
          search --no-floppy --fs-uuid --set=root d5d4eaf6-818a-4bb1-b5d4-0322a07bd6d6
        fi
        linux16 /vmlinuz-0-rescue-2bd26f952d87453faf6cde78d6300ab1 root=/dev/mapper/centos-root ro single crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet
        initrd16 /initramfs-0-rescue-2bd26f952d87453faf6cde78d6300ab1.img
}
if [ "x$default" = 'CentOS Linux (3.10.0-1160.el7.x86_64) 7 (Core)' ]; then default='Advanced options for CentOS Linux>CentOS Linux (3.10.0-1160.el7.x86_64) 7 (Core)'; fi;
### END /etc/grub.d/10_linux ###

### BEGIN /etc/grub.d/20_linux_xen ###
### END /etc/grub.d/20_linux_xen ###

### BEGIN /etc/grub.d/20_ppc_terminfo ###
### END /etc/grub.d/20_ppc_terminfo ###

### BEGIN /etc/grub.d/30_os-prober ###
### END /etc/grub.d/30_os-prober ###

### BEGIN /etc/grub.d/40_custom ###
# This file provides an easy way to add custom menu entries.  Simply type the
# menu entries you want to add after this comment.  Be careful not to change
# the 'exec tail' line above.
### END /etc/grub.d/40_custom ###

### BEGIN /etc/grub.d/41_custom ###
if [ -f  ${config_directory}/custom.cfg ]; then
  source ${config_directory}/custom.cfg
elif [ -z "${config_directory}" -a -f  $prefix/custom.cfg ]; then
  source $prefix/custom.cfg;
fi
### END /etc/grub.d/41_custom ###
```

#### 2. modify option vm.dirty_ratio:
##### - using echo utility

```bash
[root@localhost hero ~]# echo 45 > /proc/sys/vm/dirty_ratio
[root@localhost hero ~]# sysctl -a | grep 'vm.dirty_ratio'
sysctl: reading key "net.ipv6.conf.all.stable_secret"
sysctl: reading key "net.ipv6.conf.default.stable_secret"
sysctl: reading key "net.ipv6.conf.enp0s3.stable_secret"
sysctl: reading key "net.ipv6.conf.enp0s8.stable_secret"
sysctl: reading key "net.ipv6.conf.lo.stable_secret"
vm.dirty_ratio = 45
```

##### - using sysctl utility

```bash
[hero@localhost ~]$ sudo sysctl -w vm.dirty_ratio=25
vm.dirty_ratio = 25
```

##### - using sysctl configuration files

```bash
[root@localhost ~]# sudo nano /etc/sysctl.conf # added "vm.dirty_ratio=40"
[root@localhost ~]# sysctl -p
vm.dirty_ratio = 40
```

#### * extra

#### 1. Inspect initrd file contents. Find all files that are related to XFS filesystem and give a short description for every file.

```bash
[root@localhost ~]# uname -r
3.10.0-1160.49.1.el7.x86_64
[root@localhost ~]# mkinitrd /boot/initrd_1.img 3.10.0-1160.49.1.el7.x86_64
[root@localhost ~]# cpio -civt < /boot/initrd_1.img
drwxr-xr-x   3 root     root            0 Jan 17 02:55 .
drwxr-xr-x   3 root     root            0 Jan 17 02:55 kernel
drwxr-xr-x   3 root     root            0 Jan 17 02:55 kernel/x86
drwxr-xr-x   2 root     root            0 Jan 17 02:55 kernel/x86/microcode
-rw-r--r--   1 root     root         6476 Jan 17 02:55 kernel/x86/microcode/AuthenticAMD.bin
-rw-r--r--   1 root     root            2 Jan 17 02:55 early_cpio
15 blocks
```

## Selinux

#### Disable selinux using kernel cmdline

```bash
[hero@localhost ~]$ sudo nano /etc/selinux/config # SELINUX=disabled
[hero@localhost ~]$ sestatus
SELinux status:                 disabled
```

##### or

##### kernel cmdline can be used straight from boot loader (window where we can choose what condition of system should be booted) pressing E.

![bootloader](https://user-images.githubusercontent.com/33420376/149678646-4269d2c9-c57a-4e87-854b-d9c79a695978.png)

##### Pressing ctrl-x to boot with set parameters. 

![sestatus](https://user-images.githubusercontent.com/33420376/149678704-c5f4a08c-9f26-479b-8886-1d1f15f6f858.png)

## Firewalls

#### 1. Add rule using firewall-cmd that will allow SSH access to your server *only* from network 192.168.56.0/24 and interface enp0s8 (if your network and/on interface name differs - change it accordingly).

```bash
[hero@localhost ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens33: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:03:6e:91 brd ff:ff:ff:ff:ff:ff
    inet 192.168.225.132/24 brd 192.168.225.255 scope global noprefixroute dynamic ens33
       valid_lft 1120sec preferred_lft 1120sec
    inet6 fe80::8601:a46:faed:9a69/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
[hero@localhost ~]$ systemctl status firewalld
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)
   Active: active (running) since Mon 2022-01-17 02:49:23 MSK; 11min ago
     Docs: man:firewalld(1)
 Main PID: 675 (firewalld)
   CGroup: /system.slice/firewalld.service
           └─675 /usr/bin/python2 -Es /usr/sbin/firewalld --nofork --nopid

Jan 17 02:49:22 localhost.localdomain systemd[1]: Starting firewalld - dynamic firewall d.....
Jan 17 02:49:23 localhost.localdomain systemd[1]: Started firewalld - dynamic firewall daemon.
Jan 17 02:49:24 localhost.localdomain firewalld[675]: WARNING: AllowZoneDrifting is enable....
Hint: Some lines were ellipsized, use -l to show in full.

[hero@localhost ~]$ sudo firewall-cmd --zone=internal --list-all
internal
  target: default
  icmp-block-inversion: no
  interfaces:
  sources:
  services: dhcpv6-client mdns samba-client ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:

[hero@localhost ~]$ sudo firewall-cmd --zone=internal --add-port=22/tcp --permanent
success
[hero@localhost ~]$ sudo firewall-cmd --zone=internal --add-source=192.168.225.132/24 --perman
ent
success
[hero@localhost ~]$ sudo firewall-cmd --reload
success
[hero@localhost ~]$ sudo firewall-cmd --zone=internal --list-all
internal (active)
  target: default
  icmp-block-inversion: no
  interfaces:
  sources: 192.168.225.132/24
  services: dhcpv6-client mdns samba-client ssh
  ports: 22/tcp
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

#### 2. Shutdown firewalld and add the same rules via iptables.

```bash
[hero@localhost ~]$ sudo systemctl disable firewalld
Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.
[hero@localhost ~]$ systemctl stop firewalld
==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ===
Authentication is required to manage system services or units.
Authenticating as: hero
Password:
==== AUTHENTICATION COMPLETE ===
[hero@localhost ~]$ systemctl status firewalld
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:firewalld(1)

Jan 17 02:49:22 localhost.localdomain systemd[1]: Starting firewalld - dynamic firewall d.....
Jan 17 02:49:23 localhost.localdomain systemd[1]: Started firewalld - dynamic firewall daemon.
Jan 17 02:49:24 localhost.localdomain firewalld[675]: WARNING: AllowZoneDrifting is enable....
Jan 17 03:02:37 localhost.localdomain firewalld[675]: WARNING: AllowZoneDrifting is enable....
Jan 17 03:03:38 localhost.localdomain systemd[1]: Stopping firewalld - dynamic firewall d.....
Jan 17 03:03:38 localhost.localdomain systemd[1]: Stopped firewalld - dynamic firewall daemon.
Hint: Some lines were ellipsized, use -l to show in full.

[hero@localhost ~]$ systemctl start iptables
==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ===
Authentication is required to manage system services or units.
Authenticating as: hero
Password:
==== AUTHENTICATION COMPLETE ===
[hero@localhost ~]$ systemctl status iptables
● iptables.service - IPv4 firewall with iptables
   Loaded: loaded (/usr/lib/systemd/system/iptables.service; disabled; vendor preset: disabled)
   Active: active (exited) since Mon 2022-01-17 03:05:37 MSK; 4s ago
  Process: 9205 ExecStart=/usr/libexec/iptables/iptables.init start (code=exited, status=0/SUCCESS)
 Main PID: 9205 (code=exited, status=0/SUCCESS)

Jan 17 03:05:37 localhost.localdomain systemd[1]: Starting IPv4 firewall with iptables...
Jan 17 03:05:37 localhost.localdomain iptables.init[9205]: iptables: Applying firewall rul...]
Jan 17 03:05:37 localhost.localdomain systemd[1]: Started IPv4 firewall with iptables.
Hint: Some lines were ellipsized, use -l to show in full.

[hero@localhost ~]$ sudo iptables -L --line-numbers
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination
1    ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
2    ACCEPT     icmp --  anywhere             anywhere
3    ACCEPT     all  --  anywhere             anywhere
4    ACCEPT     tcp  --  anywhere             anywhere             state NEW tcp dpt:ssh
5    REJECT     all  --  anywhere             anywhere             reject-with icmp-host-prohibited

Chain FORWARD (policy ACCEPT)
num  target     prot opt source               destination
1    REJECT     all  --  anywhere             anywhere             reject-with icmp-host-prohibited

Chain OUTPUT (policy ACCEPT)
num  target     prot opt source               destination
[hero@localhost ~]$ sudo iptables -I INPUT 1 -p tcp --dport 22 -s 192.168.225.132/24 -j ACCEPT

[hero@localhost ~]$ sudo iptables -I INPUT 2 -p tcp --dport 22 -j DROP
[hero@localhost ~]$ sudo iptables -L --line-numbers
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination
1    ACCEPT     tcp  --  192.168.225.0/24     anywhere             tcp dpt:ssh
2    DROP       tcp  --  anywhere             anywhere             tcp dpt:ssh
3    ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
4    ACCEPT     icmp --  anywhere             anywhere
5    ACCEPT     all  --  anywhere             anywhere
6    ACCEPT     tcp  --  anywhere             anywhere             state NEW tcp dpt:ssh
7    REJECT     all  --  anywhere             anywhere             reject-with icmp-host-prohibited

Chain FORWARD (policy ACCEPT)
num  target     prot opt source               destination
1    REJECT     all  --  anywhere             anywhere             reject-with icmp-host-prohibited

Chain OUTPUT (policy ACCEPT)
num  target     prot opt source               destination
[hero@localhost ~]$ iptables -D INPUT 6
iptables v1.4.21: can't initialize iptables table `filter': Permission denied (you must be root)
Perhaps iptables or your kernel needs to be upgraded.
[hero@localhost ~]$ sudo iptables -D INPUT 6
[hero@localhost ~]$ sudo service iptables save
iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]
```
